# 													                                                  							后台编程规范

以user登录为例：

1. ## controller层

   ![image-20211129120254470](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20211129120254470.png)

   ```java
   @PostMapping("/login")
       @ApiOperation(value = "登录接口", notes = "返回UserLoginModel")
       public Result userLogin(@RequestBody UserLoginParam user){
   
           // 实例化统一响应结果
           Result result = new Result<>();
   
           // 调用service层的登录方法
           UserLoginModel userLoginModel = userServiceImpl.login(user.getLoginName(),user.getPasswordMd5());
   
           // 设置响应结果的result的值 （将数据返回用户对象）
           result.setData(userLoginModel);
   
           return result;
       }
   ```

​       controller层的每个方法（接口）只需要做 3 件事 

​                        （1） 接受参数

​							      前台提交表单（参数），后台要自定义 Param 类，把前台的参数封装起来

​						（2）调用service层的登录方法

  								直接调方法，(加密、参数校验、异常处理)全部封装到service层

​                                  调用service层会产生两种可能结果：

​	                                         a. 不报错，service层直接返回 data

​								             b. 报错 

​												service层抛出异常，全局异常处理类捕获异常 并 genFailResult(String Msg)

​                          （3）返回统一响应结果

​									给result赋值（code默认成功200，data就是service返回的结果）

​									**如果service层处理请求的时候抛出异常了，程序不会走到这一步,return result 一定是success的**







2. ## service 层

   ![image-20211129120326874](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20211129120326874.png)

   调用dao层的crud来做业务

```java
    /**
       登录
     * @param loginName
     * @param passwordMd5
     */
    public UserLoginModel login(String loginName, String passwordMd5){
        /* 1. 参数判断，判断用户姓名、用户密码非空 */
        checkLoginParams(loginName,passwordMd5);

        /* 2. 调用数据访问层，通过用户名查询用户记录，返回用户对象 */
        User user = userMapper.queryUserByName(loginName);

        /* 3. 判断用户对象是否为空 */
        AssertUtil.isTrue(user == null,"用户姓名不存在");

        /* 4. 判断密码是否正确，比较客户端传递的用户密码与数据库中查询的用户对象中的用户密码 */
        checkUserPwd(passwordMd5,user.getPasswordMd5());

        /* 5. 返回构建用户对象 */
        UserLoginModel userLoginModel = buildUserModel(user);

        return userLoginModel;
    }
```

注意的地方：

​				（1） 方法返回的data类型是 Model （bool 除外）

​							也就是说要自己定义对应的返回model，把返回数据封装起来

​							因为不可能直接返回User对象

​				（2）AssertUtil 断言工具的使用

```java
        /* 3. 判断用户对象是否为空 */
        AssertUtil.isTrue(user == null,"用户姓名不存在");
```

​      如果 user为空，则设置 msg = "用户姓名不存在"，并抛出自定义参数异常

```java
    /**
     * 断言工具 ：
     *     如果flag为true， 抛出错误信息为 msg 的自定义 ParamsException
     * @param flag
     * @param msg
     */
    public  static void isTrue(Boolean flag,String msg){
        if(flag){
            // 如果满足 flag ，抛出自定义msg异常
            throw  new ParamsException(msg);
        }
    }
```

这里的 ParamsException(msg) 是我自定义的异常类，作用就是能给异常加上 错误信息 msg

在service层这里抛出   ParamsException 后，全局异常处理类 GlobalExceptionHandler 会捕获

```java
              // 捕获自定义参数的异常
              if(e instanceof ParamsException)
              {
                  return ResultGenerator.genFailResult(((ParamsException) e).getMsg());
              }
```

然后 生成 统一响应结果（msg）

比如：                      **正常返回**，一路绿灯，不报错

![image-20211129121331004](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20211129121331004.png)

​									**没写密码**

​									抛出自定义异常，msg设置为密码不能为空

```java
AssertUtil.isTrue(StringUtils.isBlank(userPwd),"用户密码不能为空！");
```

![image-20211129121416096](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20211129121416096.png)

​									**密码不正确**

```java
AssertUtil.isTrue(!userPwd.equals(userPwd1),"用户密码不正确");
```

![image-20211129121554729](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20211129121554729.png)

3. dao层

   使用 Mybatis-plus，不用自己写常用的crud

   也可以自己写方法，跟mybatis一样用法

   

4. 关于加密

​      前期先不加密，方便测试，后期加密

​	  打算先把页面效果先写出来，再考虑权限和安全问题

​		